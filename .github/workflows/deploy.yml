name: Test & Deploy to DreamHost

on:
  push:
    branches: [master]
    tags: ['v*']
  pull_request:
    branches: [master]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # -------------------------------------------------------
      # Adapte esta seção conforme seu projeto.
      # Exemplos para diferentes stacks:
      # -------------------------------------------------------

      # --- Node.js ---
      # - uses: actions/setup-node@v4
      #   with:
      #     node-version: '20'
      #     cache: 'npm'
      # - run: npm ci
      # - run: npm test
      # - run: npm run build  # se houver build step

      # --- PHP ---
      # - uses: shivammathur/setup-php@v2
      #   with:
      #     php-version: '8.3'
      # - run: composer install
      # - run: vendor/bin/phpunit

      # --- Python ---
      # - uses: actions/setup-python@v5
      #   with:
      #     python-version: '3.12'
      # - run: pip install -r requirements.txt
      # - run: pytest

      # --- Site estático (Hugo, Jekyll, etc.) ---
      # - run: hugo --minify
      # - run: bundle exec jekyll build

      - name: Placeholder test
        run: echo "Configure seus testes aqui"

  deploy-staging:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    steps:
      - uses: actions/checkout@v4

      # Se o projeto tem build step, descomente:
      # - uses: actions/setup-node@v4
      #   with:
      #     node-version: '20'
      # - run: npm ci && npm run build

      - name: Deploy to staging
        env:
          SSH_PRIVATE_KEY: ${{ secrets.DREAMHOST_SSH_KEY }}
          REMOTE_HOST: ${{ secrets.DREAMHOST_HOST }}
          REMOTE_USER: ${{ secrets.DREAMHOST_USER }}
          REMOTE_PATH: ${{ secrets.DREAMHOST_STAGING_PATH }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "$REMOTE_HOST" >> ~/.ssh/known_hosts 2>/dev/null

          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'node_modules' \
            --exclude '.env' \
            ./ "${REMOTE_USER}@${REMOTE_HOST}:${REMOTE_PATH}"

          rm -f ~/.ssh/deploy_key

  deploy-production:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4

      # Se o projeto tem build step, descomente:
      # - uses: actions/setup-node@v4
      #   with:
      #     node-version: '20'
      # - run: npm ci && npm run build

      - name: Deploy to production
        env:
          SSH_PRIVATE_KEY: ${{ secrets.DREAMHOST_SSH_KEY }}
          REMOTE_HOST: ${{ secrets.DREAMHOST_HOST }}
          REMOTE_USER: ${{ secrets.DREAMHOST_USER }}
          REMOTE_PATH: ${{ secrets.DREAMHOST_PRODUCTION_PATH }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "$REMOTE_HOST" >> ~/.ssh/known_hosts 2>/dev/null

          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'node_modules' \
            --exclude '.env' \
            ./ "${REMOTE_USER}@${REMOTE_HOST}:${REMOTE_PATH}"

          rm -f ~/.ssh/deploy_key
